---
title: MySQL 中 MyISAM 和 InnoDB 存储引擎的区别
date: 2019-2-11 10:20:42
categories: [开发,数据库]
tags: [MySQL]
---

## 前言
和大多数数据库不同，MySQL 中有一个存储引擎的概念，针对不同的存储需求可以选择最优的存储引擎。

## 概述
插件式存储引擎是 MySQL 数据库最重要的特性之一，用户可以根据应用的需要选择如何存储和索引数据、是否使用事务等。**MySQL 默认支持多种存储引擎，以适用于不同领域的数据库应用需要，用户可以通过选择使用不同的存储引擎提高应用的效率，提供灵活的存储，用户甚至可以按照自己的需要定制和使用自己的存储引擎，以实现最大程度的可定制性。**

MySQL 5.0 支持的存储引擎包括 MyISAM、InnoDB、BDB、MEMORY、MERGE、EXAMPLE、NDB Cluster、ARCHIVE、CSV、BLACKHOLE、FEDERATED 等，**其中 InnoDB 和 BDB 提供事务安全表，其它存储引擎都是非事务安全表。**

## 特性
下面列出几种常见的存储引擎，并对比之间的区别。

|特点|MyISAM|InnoDB|MEMORY|MERGE|NDB|
|:-:|:-:|:-:|:-:|:-:|:-:|
|存储限制|有|64TB|有|没有|有|
|事务安全||支持||||
|锁机制|表锁|行锁|表锁|表锁|行锁|
|B 树索引|支持|支持|支持|支持|支持|
|哈希索引|||支持||支持|
|全文索引|支持|||||
|集群索引||支持||||
|数据缓存||支持|支持||支持|
|索引缓存|支持|支持|支持|支持|支持|
|数据可压缩|支持|||||
|空间使用|低|高|N/A|低|低|
|内存使用|低|高|中等|低|高|
|批量插入的速度|高|低|高|高|高|
|支持外键||支持||||

**本文重点介绍最常遇到的两种存储引擎：MyISAM 和 InnoDB。**

## MyISAM
**MyISAM 是 MySQL 的默认存储引擎。MyISAM 不支持事务、也不支持外键，其优势是访问的速度快，对事务完整性没有要求或者以 SELECT、INSERT 为主的应用基本上都可以使用这个引擎来创建表。**

每个 MyISAM 在磁盘上存储成 3 个文件，其文件名都和表名相同，但扩展名分别是：

- .frm（存储表定义）
- .MYD（MYData，存储数据）
- .MYI（MYIndex，存储索引）

数据文件和索引文件可以放置在不同的目录，平均分布 IO，获得更快的速度。

MyISAM 类型的表可能会损坏，原因可能是多种多样的，损坏后的表可能不能访问，会提示需要修复或者访问后返回错误的结果。**MyISAM 类型的表提供修复的工具，可以用 CHECK TABLE 语句来检查 MyISAM 表的健康，并用 REPAIR TABLE 语句修复一个损坏的 MyISAM 表。**表损坏可能导致数据库异常重新启动，需要尽快修复并尽可能地确认损坏的原因。

MyISAM 的表又支持 3 种不同的存储格式，分别是：

- 静态（固定长度）表
- 动态表
- 压缩表

**其中，静态表是默认的存储格式。静态表中的字段都是非变长字段，这样每个记录都是固定长度的，这种存储方式的`优点是存储非常迅速，容易缓存，出现故障容易恢复`；`缺点是占用的空间通常比动态表多`。静态表的数据在存储的时候会按照列的宽度定义补足空格，但是在应用访问的时候并不会得到这些空格，这些空格在返回给应用之前已经去掉。**

## InnoDB
**InnoDB 存储引擎提供了具有提交、回滚和崩溃恢复能力的事务安全。但是对比 MyISAM 的存储引擎，InnoDB 写的处理效率差一些并且会占用更多的磁盘空间以保留数据和索引。**

### 自动增长列
InnoDB 表的自动增长列可以手工插入，但是插入的值如果是空或者 0，则实际插入的将是自动增长后的值。

可以通过 `ALTER TABLE *** AUTO_INCREMENT = n` 语句强制设置自动增长列的初始值，默认从 1 开始，但是该强制的默认值是保留在内存中的，如果该值在使用之前数据库重新启动，那么这个强制的默认值就会丢失，就需要在数据库启动以后重新设置。

可以使用 `LAST_INSERT_ID()` 查询当前线程最后插入记录使用的值。如果一次插入了多条记录，那么返回的是第一条记录使用的自动增长值。

**对于 InnoDB 表，自动增长列必须是索引。如果是组合索引，也必须是组合索引的第一列，但是对于 MyISAM 表，自动增长列可以是组合索引的其它列，这样插入记录后，自动增长列是按照组合索引的前面几列进行排序后递增的。**

### 外键约束
MySQL 支持外键的存储引擎只有 InnoDB，在创建外键的时候，要求父表必须有对应的索引，子表在创建外键的时候也会自动创建对应的索引。

在创建索引的时候，可以指定在删除、更新父表时，对子表进行的相应操作，包括 RESTRICT、CASCADE、SET NULL 和 NO ACTION。其中 RESTRICT 和 NO ACTION 相同，是指限制在子表有关联记录的情况下父表不能更新；CASCADE 表示父表在更新或者删除时，更新或者删除子表对应记录；SET NULL 则表示父表在更新或者删除的时候，子表的对应字段被 SET NULL。选择后两种方式的时候要谨慎，可能会因为错误的操作导致数据的丢失。

**当某个表被其他表创建了外键参照，那么该表的对应索引或者主键禁止被删除。**

### 存储方式
InnoDB 存储表和索引有以下两种方式。

- 使用共享表空间存储，这种方式创建的表的表结构保存在 .frm 文件中，数据和索引保存在 `innodb_data_home_dir` 和 `innodb_data_file_path` 定义的表空间中，可以是多个文件。
- 使用多表空间存储，这种方式创建的表的表结构仍然保存在 .frm 文件中，但是每个表的数据和索引单独保存在 .ibd 中。如果是个分区表，则每个分区对应单独的 .ibd 文件，文件名是“表名+分区名”，可以在创建分区的时候指定每个分区的数据文件的位置，以此来将表的 IO 均匀分布在多个磁盘上。

要使用多表空间的存储方式，需要设置参数 `innodb_file_per_table`，并重新启动服务后才可以生效，对于新建的表按照多表空间的方式创建，已有的表仍然使用共享表空间存储。如果将已有的多表空间方式修改回共享表空间的方式，则新建表会在共享表空间中创建，但已有的多表空间的表仍然保存原来的访问方式。所以多表空间的参数生效后，只对新建的表生效。


**多表空间的数据文件没有大小限制，不需要设置初始大小，也不需要设置文件的最大限制、扩展大小等参数。**

对于使用多表空间特性的表，可以比较方便地进行单表备份和恢复操作，但是直接复制 .ibd 文件是不行的，因为没有共享表空间的数据字典信息，直接复制的 .ibd 文件和 .frm 文件恢复时是不能被正确识别的，但可以通过以下命令：
```
ALTER TABLE tbl_name DISCARD TABLESPACE;
ALTER TABLE tbl_name IMPORT TABLESPACE;
```
将备份恢复到数据库中，但是这样的单表备份，只能恢复到表原来在的数据库中，而不能恢复到其他的数据库中。如果要将单表恢复到目标数据库，则需要通过 `mysqldump` 和 `mysqlimport` 来实现。

**注意：即便在多表空间的存储方式下，共享表空间仍然是必须的，InnoDB 把内部数据词典和工作日志放在这个文件中。**

## 适用环境
在选择存储引擎时，应根据应用特点选择合适的存储引擎，对于复杂的应用系统可以根据实际情况选择多种存储引擎进行组合。

- MyISAM：默认的 MySQL 插件式存储引擎。如果应用是以读操作和插入操作为主，只有很少的更新和删除操作，并且对事务的完整性、并发性要求不是很高，那么选择这个存储引擎是非常适合的。MyISAM 是在 Web、数据仓储和其他应用环境下最常使用的存储引擎之一。
- InnoDB：用于事务处理应用程序，支持外键。如果应用对事务的完整性有比较高的要求，在并发条件下要求数据的一致性，数据操作除了插入和查询以外，还包括很多的更新、删除操作，那么 InnoDB 存储引擎应该是比较合适的选择。InnoDB 存储引擎除了有效地降低由于删除和更新导致的锁定，还可以确保事务的完整提交（Commit）和回滚（Rollback），对于类似计费系统或者财务系统等对数据准确性要求比较高的系统，InnoDB 都是合适的选择。

> 本文大多摘自《深入浅出MySQL》。
